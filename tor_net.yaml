#!/usr/bin/ansible-playbook
---
  - name: "Configure tor-net in rkn"
    hosts: localhost
    connection: local
    tasks:
        - get_url:
            checksum: "sha256:2d11b98ce1db0acdb9ed657b8b7a52d3491f4cb9cab7fab79d386f0f9a223bff"
            dest: /usr/local/bin/tun2socks
            mode: 0755
            url: https://github.com/eycorsican/go-tun2socks/releases/download/v1.16.8/tun2socks-linux-amd64
        - apt:
            name:
                - torsocks
                - tor
        - uri:
            url: "{{ item }}"
            return_content: yes
            status_code: 200
          register: list
          with_items:
              - "https://antifilter.download/list/subnet.lst"
              - "https://antifilter.download/list/ipsum.lst"
          check_mode: false
        - copy:
            dest: /etc/network/interfaces.d/tun-tor
            content: |
                auto tun-tor
                iface tun-tor inet static
                    pre-up ip tuntap add mode tun dev tun-tor 2>/dev/null || true
                    post-up /usr/local/bin/rkn-net.sh &
                    address 10.255.0.2/24
                    post-down ip link del dev tun-tor
        - copy:
            dest: /usr/local/bin/rkn-net.sh
            mode: 0755
            content: |
                #!/bin/bash
                {% for z in list.results %}
                {%  for x in z.content.split('\n') %}
                {%    if x != "" %}
                ip route add {{ x }} via 10.255.0.1
                {%    endif %}
                {%  endfor %}
                {% endfor %}
        - copy:
            dest: /etc/systemd/system/tun2socks.service
            content: |
                [Unit]
                After=network.target

                [Service]
                ExecStart=/usr/local/bin/tun2socks -proxyServer 127.0.0.1:9050 -tunName tun-tor -tunPersist -loglevel none
                Restart=on-failure
                Type=exec

                [Install]
                WantedBy=multi-user.target
        - systemd:
            daemon_reload: yes
        - systemd:
            name: tun2socks.service
            state: started
            enabled: yes
